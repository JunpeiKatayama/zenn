---
title: League of Legends の戦績を集計する Discord BOT を作ったメモ
emoji: "🧙"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

## はじめに

League of Legends(以降 LoL)の戦績を集計する Discord の BOT を作りました。
OPGG だと広告の表示領域が大きすぎて気になるため。
![OPGGのSS](/images/image.png)

その中で、先に知っていればよかったな～と思ったことを記載します。

なお、後述しますが、この BOT は身内向けであり、全てのサーバに対して招待できるようにするつもりはありません。
（サーバの維持コストがすごいことになりそうなので）

また、実装のほとんどを AI に任せているということもあり、具体的な説明があんまりない、みたいなことになってしまわないか執筆前から不安である。

## BOT の紹介

以下のように、コマンドに応じた集計結果を画像で返却する BOT です。
この例は `/recent` コマンドによるもの。
![直近の戦績を現すrecentコマンドの返す画像](/images/recent.png)

他にも直近の戦績を集計した `/stats` コマンド、特定のチャンピオンを指定して戦績を集計できる `/champion` コマンドなどがあります。

![直近100試合の戦績をまとめたstatsコマンドの返す画像](/images/stats.png)
![特定チャンピオンの戦績をまとめたchampionコマンドの返す画像](/images/stats.png)
(しょうもないチャンピオンばかり使って勝率が低いことには目をつぶってください)

## 知っておきたかったこと

それでは、BOT を作る前に知っているとよかったな～ということを以下に記載します。

### Riot API の厳しすぎるレートリミット

Developper Portal の自身の登録した APP 情報で確認できますが、結構厳しいレートリミットが課せられています。

```
20 requests every 1 seconds
100 requests every 2 minutes
```

例えば試合情報を取得したいとき、まずは API に問い合わせ、そのユーザのゲームの ID のリストを取得します。
試合詳細をまとめて取得する API はないため、1 件ずつ問い合わせるしかありません。
100 試合分析したいなら、それだけで 101 回リクエストする必要があります。

利用者が同時にコマンドを使用することも加味すると、簡単にレートリミットに達してしまうため、それを考慮してちょっとずつ集計するような工夫が必要となります。

### レートリミット対策

以下コードブロック部分は AI に調査された回答を引用しています。

1. リクエストレートを計測し、同時実行を直列化
   ```
   シンプルなトークンバケット。
   デフォルトは 20 req/sec と 100 req/120s をキュー (deque) で計測し、超えそうなら asyncio.sleep で待機してからタイムスタンプを記録。
   asyncio.Lock で同時実行を直列化
   ```
2. キャッシュによる呼び出し削減
   ```
   PostgreSQLベースのTTLキャッシュを使い、Summonerは24h、マッチ一覧は5分、マッチ詳細は期限なしで保存（config.py参照）。
   まず get_many でバルクヒットを拾い、未取得分だけAPIを叩くため、実リクエスト数を圧縮。
   ```
   マッチ詳細が無期限キャッシュになっているのは、一度確定した試合結果は変更されないからです。
   これによって大量のキャッシュが必要となり、コストを考えると、BOT を大規模に公開することは不可となりました。
   （こんなものに月 1000 円も払いたくないよね・・・？）
3. 構造化ログ
   ```
   api_request メトリクスをJSONロギング、429時は api_rate_limit を記録。
   キャッシュのヒット/ミスもイベントで出るので、実際の呼び出し状況をログから追跡可能。
   ```
   個人開発あるあるなのですが、APM は高すぎて使えないため構造化ログは便利です。
   特に今回はほとんど全てをバイブコーディングで実装したため、気になったときにログを確認して、悪そうなロジックを推測して直してもらう、といった文脈でも役に立ちました。

### LoL 関連の静的ファイル

LoL 関連の静的ファイル(チャンピオンアイコン・スプラッシュアート/アイテムやサモナースペルのアイコン等)は DataDoragon という Riot 公式の CDN から取得できます。
https://developer.riotgames.com/docs/lol

ちなみに、画像のパスや名前が思っていたものと異なることがたまにあります。

例えば、フィドルスティックスのアイコンが取得できない問題がありました。
フィドルは Riot API では `FiddleSticks` の表記とされていますが、DataDoragon では `Fiddlesticks` で表記されています。
なので、専用の辞書をいくつか用意してあげないといけない、ということが起こると思います。

### デプロイ先問題

僕がこの業界に入ったばかりのころは Heroku に無料でホスティングできていたのですが、今は無料のサービスってほとんどないです。
この BOT は大してスペックを必要としないため、できるだけ安上がりなサービスを使いたい、とはいえ環境構築に苦心するのは嫌だ・・・ということで Railway を選びました。

https://railway.com/

Railway は初月無料で Hobby プランを使えます。
Hobby プランは毎月$5 のクレジットを購入して、それを使い切るまでは無料(?)で使えるといったもの。
無料プランの場合は$1 分は毎月無料で使えるそうです。

BOT 本体 + Postgres を半月ほど利用して、$1 もかかっていないので、無料プランでもいけるかも？
![半月つかったときのコスト感](/images/railway-trial-banner.png)

さらに、Railway では DockerFile を置いておくだけで簡単に GitHub リポジトリと連携してデプロイすることができるので、環境構築がめちゃくちゃ楽です。
(1 日 30 回程度のデプロイ回数の上限があるので注意）
Postgres 等のリソースもブラウザ上からぽちぽちやれば簡単に作成できます。便利。

![こんな感じの管理画面](/images/railway-dashboard.png)
Postgres につなぎたかったらこの環境変数を設定してね！みたいな案内もあるので迷子になることはなさそう。

## LoL の戦績集計 BOT を作った感想

OPGG を見るよりもスッキリと戦績を見られるようになってよかったと思います。
また、フレンドに使ってもらってフィードバックを反映したり、こつこつ改善したりといった楽しさを思い出させてくれました。
こういったアプリでは世界的なチャンピオンビルドの統計を取ることはできませんが、プレイヤー個人レベルの情報の統計を取るのには充分だと感じました！

これを見てやってみたいなと思った方、Claude Code 契約して作ってというだけでポン、とできるようになっているのでおすすめです。
(進化が早すぎてついていけない・・・)
